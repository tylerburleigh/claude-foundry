#!/usr/bin/env bash
# setup-permissions - Manage Claude Code permissions for foundry plugin
#
# Usage: ./setup-permissions [--check | --diff | --apply | --create]
#
# Options:
#   --check   Exit 0 if permissions complete, exit 1 if missing
#   --diff    Output JSON diff of missing permissions (default)
#   --apply   Merge missing permissions into user's file
#   --create  Create new file with all permissions
#
# Environment:
#   WORKSPACE_DIR  Target workspace directory (default: current dir)

set -euo pipefail

# Resolve script directory for permissions.json location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PERMISSIONS_FILE="${SCRIPT_DIR}/permissions.json"

# Target workspace
WORKSPACE_DIR="${WORKSPACE_DIR:-.}"
SETTINGS_DIR="${WORKSPACE_DIR}/.claude"
SETTINGS_FILE="${SETTINGS_DIR}/settings.local.json"

# Detect JSON tool (jq preferred, python fallback)
if command -v jq &> /dev/null; then
    JSON_TOOL="jq"
else
    JSON_TOOL="python"
fi

# ============================================================================
# JSON Helper Functions
# ============================================================================

json_extract() {
    local json="$1"
    local path="$2"

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$json" | jq -r "$path"
    else
        python3 -c "
import sys, json
data = json.loads('''$json''')
path = '$path'.strip('.')
if path:
    for key in path.split('.'):
        if key.startswith('[') and key.endswith(']'):
            data = data[int(key[1:-1])]
        else:
            data = data.get(key, None) if isinstance(data, dict) else None
        if data is None:
            break
print(json.dumps(data) if isinstance(data, (dict, list)) else (data if data else 'null'))
"
    fi
}

json_array_to_lines() {
    local json="$1"

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$json" | jq -r '.[]' 2>/dev/null || echo ""
    else
        python3 -c "
import sys, json
try:
    data = json.loads('''$json''')
    if isinstance(data, list):
        for item in data:
            print(item)
except:
    pass
"
    fi
}

json_build_output() {
    # Build JSON output using Python (more reliable for complex structures)
    python3 -c "
import sys, json

status = '$1'
file_path = '$2'
missing_allow = '''$3'''.strip().split('\n') if '''$3'''.strip() else []
missing_deny = '''$4'''.strip().split('\n') if '''$4'''.strip() else []
user_custom = '''$5'''.strip().split('\n') if '''$5'''.strip() else []
action_taken = '$6'
missing_by_category = json.loads('''$7''') if '''$7''' else {}

# Filter empty strings
missing_allow = [x for x in missing_allow if x]
missing_deny = [x for x in missing_deny if x]
user_custom = [x for x in user_custom if x]

output = {
    'status': status,
    'file_path': file_path,
    'missing': {
        'allow': missing_allow,
        'deny': missing_deny
    },
    'missing_by_category': missing_by_category,
    'user_custom': user_custom,
    'action_taken': action_taken
}

print(json.dumps(output, indent=2))
"
}

# ============================================================================
# Permission Logic
# ============================================================================

get_required_permissions() {
    # Extract all required allow permissions from permissions.json
    if [ ! -f "$PERMISSIONS_FILE" ]; then
        echo "Error: permissions.json not found at $PERMISSIONS_FILE" >&2
        exit 1
    fi

    local perms_json
    perms_json=$(cat "$PERMISSIONS_FILE")

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$perms_json" | jq -r '.categories | to_entries | .[].value.allow[]'
    else
        python3 -c "
import json
data = json.loads('''$perms_json''')
for cat in data.get('categories', {}).values():
    for perm in cat.get('allow', []):
        print(perm)
"
    fi
}

get_required_deny() {
    # Extract all required deny permissions from permissions.json
    local perms_json
    perms_json=$(cat "$PERMISSIONS_FILE")

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$perms_json" | jq -r '.deny_rules.deny[]'
    else
        python3 -c "
import json
data = json.loads('''$perms_json''')
for perm in data.get('deny_rules', {}).get('deny', []):
    print(perm)
"
    fi
}

get_user_permissions() {
    # Extract user's current allow permissions
    if [ ! -f "$SETTINGS_FILE" ]; then
        return
    fi

    local user_json
    user_json=$(cat "$SETTINGS_FILE")

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$user_json" | jq -r '.permissions.allow[]?' 2>/dev/null || echo ""
    else
        python3 -c "
import json
try:
    data = json.loads('''$user_json''')
    for perm in data.get('permissions', {}).get('allow', []):
        print(perm)
except:
    pass
"
    fi
}

get_user_deny() {
    # Extract user's current deny permissions
    if [ ! -f "$SETTINGS_FILE" ]; then
        return
    fi

    local user_json
    user_json=$(cat "$SETTINGS_FILE")

    if [ "$JSON_TOOL" = "jq" ]; then
        echo "$user_json" | jq -r '.permissions.deny[]?' 2>/dev/null || echo ""
    else
        python3 -c "
import json
try:
    data = json.loads('''$user_json''')
    for perm in data.get('permissions', {}).get('deny', []):
        print(perm)
except:
    pass
"
    fi
}

categorize_permission() {
    local perm="$1"

    if [[ "$perm" == Skill\(* ]]; then
        echo "skills"
    elif [[ "$perm" == mcp__plugin_foundry_foundry-mcp__* ]]; then
        echo "mcp_tools"
    elif [[ "$perm" == mcp__plugin_foundry_foundry-ctl__* ]]; then
        echo "mcp_ctl"
    elif [[ "$perm" == Bash\(git\ * ]]; then
        echo "git_commands"
    elif [[ "$perm" == *pytest* ]]; then
        echo "testing"
    elif [[ "$perm" == *foundry* ]]; then
        echo "foundry_cli"
    elif [[ "$perm" == *codex* ]] || [[ "$perm" == *claude* ]] || [[ "$perm" == *gemini* ]] || [[ "$perm" == *cursor-agent* ]] || [[ "$perm" == *opencode* ]]; then
        echo "ai_providers"
    elif [[ "$perm" == Write\(* ]]; then
        echo "specs_write"
    elif [[ "$perm" == Edit\(* ]]; then
        echo "specs_edit"
    else
        echo "other"
    fi
}

compute_diff() {
    # Compute missing permissions
    local required_allow missing_allow user_allow
    local required_deny missing_deny user_deny
    local user_custom

    required_allow=$(get_required_permissions | sort -u)
    user_allow=$(get_user_permissions | sort -u)

    required_deny=$(get_required_deny | sort -u)
    user_deny=$(get_user_deny | sort -u)

    # Compute missing (in required but not in user)
    missing_allow=$(comm -23 <(echo "$required_allow") <(echo "$user_allow") 2>/dev/null || echo "$required_allow")
    missing_deny=$(comm -23 <(echo "$required_deny") <(echo "$user_deny") 2>/dev/null || echo "$required_deny")

    # Compute user custom (in user but not in required)
    user_custom=$(comm -13 <(echo "$required_allow") <(echo "$user_allow") 2>/dev/null || echo "")

    # Categorize missing permissions
    local categories_json="{}"
    while IFS= read -r perm; do
        [ -z "$perm" ] && continue
        local cat
        cat=$(categorize_permission "$perm")
        categories_json=$(python3 -c "
import json
data = json.loads('$categories_json')
cat = '$cat'
perm = '''$perm'''
if cat not in data:
    data[cat] = []
data[cat].append(perm)
print(json.dumps(data))
")
    done <<< "$missing_allow"

    # Add deny rules to categories if missing
    if [ -n "$missing_deny" ]; then
        while IFS= read -r perm; do
            [ -z "$perm" ] && continue
            categories_json=$(python3 -c "
import json
data = json.loads('$categories_json')
perm = '''$perm'''
if 'deny_rules' not in data:
    data['deny_rules'] = []
data['deny_rules'].append(perm)
print(json.dumps(data))
")
        done <<< "$missing_deny"
    fi

    # Determine status
    local status
    if [ ! -f "$SETTINGS_FILE" ]; then
        status="no_file"
    elif ! python3 -c "import json; json.load(open('$SETTINGS_FILE'))" 2>/dev/null; then
        status="invalid"
    elif [ -z "$missing_allow" ] && [ -z "$missing_deny" ]; then
        status="complete"
    else
        status="missing"
    fi

    # Build output
    json_build_output "$status" "$SETTINGS_FILE" "$missing_allow" "$missing_deny" "$user_custom" "none" "$categories_json"
}

create_permissions_file() {
    # Create new settings file with all required permissions
    mkdir -p "$SETTINGS_DIR"

    local required_allow required_deny
    required_allow=$(get_required_permissions)
    required_deny=$(get_required_deny)

    python3 -c "
import json

allow = '''$required_allow'''.strip().split('\n')
deny = '''$required_deny'''.strip().split('\n')

allow = [x for x in allow if x]
deny = [x for x in deny if x]

settings = {
    'permissions': {
        'allow': allow,
        'deny': deny
    }
}

with open('$SETTINGS_FILE', 'w') as f:
    json.dump(settings, f, indent=2)
    f.write('\n')
"

    echo "created"
}

apply_permissions() {
    # Merge missing permissions into existing file
    if [ ! -f "$SETTINGS_FILE" ]; then
        create_permissions_file
        return
    fi

    # Backup if file exists but is invalid
    if ! python3 -c "import json; json.load(open('$SETTINGS_FILE'))" 2>/dev/null; then
        mv "$SETTINGS_FILE" "${SETTINGS_FILE}.backup"
        create_permissions_file
        echo "backed_up"
        return
    fi

    local required_allow required_deny
    required_allow=$(get_required_permissions)
    required_deny=$(get_required_deny)

    python3 -c "
import json

# Read existing settings
with open('$SETTINGS_FILE', 'r') as f:
    settings = json.load(f)

# Ensure permissions structure exists
if 'permissions' not in settings:
    settings['permissions'] = {}
if 'allow' not in settings['permissions']:
    settings['permissions']['allow'] = []
if 'deny' not in settings['permissions']:
    settings['permissions']['deny'] = []

# Get required permissions
required_allow = '''$required_allow'''.strip().split('\n')
required_deny = '''$required_deny'''.strip().split('\n')
required_allow = [x for x in required_allow if x]
required_deny = [x for x in required_deny if x]

# Merge (add missing, preserve existing)
existing_allow = set(settings['permissions']['allow'])
existing_deny = set(settings['permissions']['deny'])

for perm in required_allow:
    if perm not in existing_allow:
        settings['permissions']['allow'].append(perm)

for perm in required_deny:
    if perm not in existing_deny:
        settings['permissions']['deny'].append(perm)

# Write back
with open('$SETTINGS_FILE', 'w') as f:
    json.dump(settings, f, indent=2)
    f.write('\n')
"

    echo "merged"
}

# ============================================================================
# Main
# ============================================================================

main() {
    local mode="${1:---diff}"

    case "$mode" in
        --check)
            local result
            result=$(compute_diff)
            local status
            status=$(echo "$result" | python3 -c "import sys, json; print(json.load(sys.stdin)['status'])")
            if [ "$status" = "complete" ]; then
                exit 0
            else
                exit 1
            fi
            ;;
        --diff)
            compute_diff
            ;;
        --apply)
            local action
            action=$(apply_permissions)
            # Re-run diff with action noted
            local result
            result=$(compute_diff)
            echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
data['action_taken'] = '$action'
print(json.dumps(data, indent=2))
"
            ;;
        --create)
            mkdir -p "$SETTINGS_DIR"
            local action
            action=$(create_permissions_file)
            local result
            result=$(compute_diff)
            echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
data['action_taken'] = '$action'
print(json.dumps(data, indent=2))
"
            ;;
        *)
            echo "Usage: $0 [--check | --diff | --apply | --create]" >&2
            exit 1
            ;;
    esac
}

main "$@"
