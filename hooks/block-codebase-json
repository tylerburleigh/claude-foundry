#!/usr/bin/env bash
# PreToolUse hook to block reading codebase.json files
# Forces use of doc-query skill instead of direct file reading

set -euo pipefail

# Read JSON input from stdin
input=$(cat)

# Extract file_path from tool_input using jq (or fall back to grep/sed if jq unavailable)
if command -v jq &> /dev/null; then
    file_path=$(echo "$input" | jq -r '.tool_input.file_path // empty')
else
    # Fallback: simple extraction using grep/sed
    file_path=$(echo "$input" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
fi

# If no file_path found, allow (might be a different Read operation)
if [ -z "$file_path" ]; then
    exit 0
fi

# Check if file path matches */codebase.json pattern
if [[ "$file_path" == */codebase.json ]]; then
    # Block the read with helpful error message
    cat >&2 <<'EOF'

╔════════════════════════════════════════════════════════════════════════╗
║                  ⛔ CODEBASE.JSON READ BLOCKED                         ║
╚════════════════════════════════════════════════════════════════════════╝

WHAT: You attempted to read a codebase.json file directly.

WHY: codebase.json files are extremely large (often 5-10+ MB) and will
     consume massive amounts of context tokens, making them impractical
     to read directly. The doc-query skill provides optimized tools for
     querying codebase documentation efficiently.

HOW TO FIX:
  Since you're in Claude Code, use Skills or MCP tools instead of reading codebase.json.

  PRIMARY: Use doc-query Skill (recommended)
  ──────────────────────────────────────────
  Skill(doc-query) provides high-level workflows:
    - "find class ClassName"
    - "find function function_name"
    - "scope module=src/path.py mode=implement"
    - "trace entry function=process_request depth=3"
    - "impact entity=UserService depth=2"
    - "refactor candidates min_complexity=15"

  ALTERNATIVE: MCP tools (for granular operations)
  ────────────────────────────────────────────────
  mcp__plugin_foundry_foundry-mcp__code action="find-class" symbol="..."
  mcp__plugin_foundry_foundry-mcp__code action="find-function" symbol="..."
  mcp__plugin_foundry_foundry-mcp__code action="get-callers" symbol="..."
  mcp__plugin_foundry_foundry-mcp__code action="get-callees" symbol="..."
  mcp__plugin_foundry_foundry-mcp__code action="trace-calls" symbol="..." depth=3
  mcp__plugin_foundry_foundry-mcp__code action="impact-analysis" symbol="..."
  mcp__plugin_foundry_foundry-mcp__code action="doc-stats"

EXAMPLES:
  Instead of: Read(docs/codebase.json)
    Use: Skill(doc-query) OR mcp__plugin_foundry_foundry-mcp__code action="find-class" symbol="Validator"

  Instead of: Reading entire file to find a function
    Use: Skill(doc-query) OR mcp__plugin_foundry_foundry-mcp__code action="find-function" symbol="process_spec"

  Instead of: Searching for call relationships in the JSON
    Use: Skill(doc-query) OR mcp__plugin_foundry_foundry-mcp__code action="trace-calls" symbol="validate_spec"

⚠️  CRITICAL: Do not use Python, cat, jq, Read(), or any other method to bypass this
   restriction. ALL codebase.json access must go through Skills or MCP tools.

This hook enforces efficient codebase querying and prevents token waste.

EOF
    exit 2
fi

# Allow the read for other files
exit 0
