#!/usr/bin/env bash
# PreToolUse hook to block Bash commands that directly access .json spec files
# Prevents bypassing the Read() hook by using any file I/O method

set -euo pipefail

# Read JSON input from stdin
input=$(cat)

# Extract command from tool_input using jq (or fall back to grep/sed if jq unavailable)
if command -v jq &> /dev/null; then
    bash_command=$(echo "$input" | jq -r '.tool_input.command // empty')
else
    # Fallback: simple extraction using grep/sed
    bash_command=$(echo "$input" | grep -o '"command"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"command"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' | head -1)
fi

# If no command found, allow
if [ -z "$bash_command" ]; then
    exit 0
fi

# Check for any pattern that indicates direct spec file access
# Patterns cover: Python (json.load/open), bash tools (cat/head/tail/etc), jq, and other file I/O
if echo "$bash_command" | grep -qE "(python.*json\.load.*specs/(active|pending|completed|archived))|(python.*open\(['\"].*specs/(active|pending|completed|archived))|((cat|head|tail|less|more|sed|awk|grep).*specs/(active|pending|completed|archived)/.*\.json)|(jq.*specs/(active|pending|completed|archived)/.*\.json)"; then
    cat >&2 <<'EOF'

╔════════════════════════════════════════════════════════════════════════╗
║                  ⛔ SPEC FILE ACCESS BLOCKED                           ║
╚════════════════════════════════════════════════════════════════════════╝

WHAT: You attempted to directly access a .json specification file via Bash command.

WHY: This bypasses the Read() hook and wastes context tokens.
     JSON specs are often very large (50KB+). The SDD toolkit provides
     optimized tools for working with specs efficiently.

HOW TO FIX:
  Since you're in Claude Code, use Skills or MCP tools instead of Bash commands on spec files.

  PRIMARY: Use Skills (recommended)
  ─────────────────────────────────
  Skill(sdd-next)      - Get next task with full implementation context
  Skill(sdd-update)    - Update task status, complete tasks, add journals
  Skill(sdd-validate)  - Validate spec and auto-fix issues
  Skill(sdd-modify)    - Add/remove tasks, apply structural changes

  ALTERNATIVE: MCP tools (for granular operations)
  ────────────────────────────────────────────────
  mcp__plugin_foundry_foundry-mcp__task action="next" spec_id="<id>"
  mcp__plugin_foundry_foundry-mcp__task action="query" spec_id="<id>" status="pending"
  mcp__plugin_foundry_foundry-mcp__task action="info" spec_id="<id>" task_id="<task-id>"
  mcp__plugin_foundry_foundry-mcp__task action="progress" spec_id="<id>"
  mcp__plugin_foundry_foundry-mcp__spec action="get-hierarchy" spec_id="<id>"
  mcp__plugin_foundry_foundry-mcp__task action="complete" spec_id="<id>" task_id="<id>" completion_note="..."
  mcp__plugin_foundry_foundry-mcp__spec action="apply-plan" spec_id="<id>"

EXAMPLES:
  Querying: Instead of python -c "import json; ..." or jq on specs
    Use: Skill(sdd-next) OR mcp__plugin_foundry_foundry-mcp__task action="query" spec_id="my-spec" status="pending"

  Modifying: Instead of Python script or sed/awk on spec JSON
    Use: Skill(sdd-modify) OR mcp__plugin_foundry_foundry-mcp__spec action="apply-plan" spec_id="..."

  Reading: Instead of cat specs/active/my-spec.json
    Use: Skill(sdd-next) OR mcp__plugin_foundry_foundry-mcp__task action="prepare" spec_id="my-spec"

⚠️  CRITICAL: ALL spec file access must go through Skills or MCP tools.
   If Read() is blocked, Bash file I/O is also blocked. Use the tools above.

This hook enforces proper SDD workflow and prevents token waste.

EOF
    exit 2
fi

# Allow all other bash commands
exit 0
